<?xml version="1.0"?>
<project name="server">

    <!-- set APACHE_LOG_DIR environment variable for apache config files -->
    <property environment="env" />
    <condition property="apache.log.dir" value="${env.APACHE_LOG_DIR}">
        <isset property="env.APACHE_LOG_DIR"/>
    </condition>
    <property name="apache.log.dir" value="/opt/tt/log/outcomes" />

    <target name="set-apache-props">
        <exec executable="ls" failonerror="false" resultproperty="vm">
            <arg value="/etc/redhat-release"/>
        </exec>
        <if>
            <os family="mac"/>
            <then>
                <property name="apachectl" value="/usr/sbin/apachectl"/>
                <property name="conf" location="${apache.config.dir}/dev-local-httpd-mac.conf"/>
            </then>
            <elseif>
                <equals arg1="${vm}" arg2="0"/>
                <then>
                    <property name="apachectl" value="/usr/sbin/apachectl"/>
                    <property name="conf" location="${apache.config.dir}/dev-local-httpd.conf"/>
                </then>
            </elseif>
            <else>
                <echo>NOTE: the APACHE_LOG_DIR variable is not respected by Ubuntu!</echo>
                <echo>Apache error log and PID file will be in /opt/tt/log/outcomes,</echo>
                <echo>regardless of property or environment variable settings.</echo>
                <property name="apachectl" value="/usr/sbin/apache2ctl"/>
                <property name="conf" location="${apache.config.dir}/dev-local-httpd-ubuntu.conf"/>
            </else>
        </if>
    </target>

    <target name="set-apache-props-lb">
        <exec executable="which" failonerror="false" resultproperty="vm">
            <arg value="/usr/sbin/apachectl"/>
        </exec>
        <if>
            <equals arg1="${vm}" arg2="0"/>
            <then>
                <property name="apachectl" value="/usr/sbin/apachectl"/>
                <property name="conf" location="${apache.config.dir}/dev-local-lb-httpd.conf"/>
            </then>
            <else>
                <echo>NOTE: the APACHE_LOG_DIR variable is not respected by Ubuntu!</echo>
                <echo>Apache error log and PID file will be in /opt/tt/log/outcomes,</echo>
                <echo>regardless of property or environment variable settings.</echo>
                <property name="apachectl" value="/usr/sbin/apache2ctl"/>
                <property name="conf" location="${apache.config.dir}/dev-local-lb-httpd-ubuntu.conf"/>
            </else>
        </if>
    </target>

    <!--
       run apachectl with the given command, assuming that "apachectl" and "conf" properties
       were already set appropriately
    -->
    <macrodef name="apachectl" description="run apachectl with the appropriate config">
        <attribute name="command"/>
        <sequential>
            <exec executable="bash" failonerror="true">
                <env key="APACHE_LOG_DIR" file="${apache.log.dir}" />
                <arg value="${apachectl}"/>
                <arg value="-f"/>
                <arg value="${conf}"/>
                <arg value="-k"/>
                <arg value="@{command}"/>
            </exec>
        </sequential>
    </macrodef>

    <target name="apache-start" depends="set-apache-props" description="Start apache">
        <apachectl command="start" />
    </target>

    <target name="apache-start-lb" depends="set-apache-props-lb" description="Start apache for the local load balancer">
        <apachectl command="start"/>
    </target>
    
    <target name="apache-stop" depends="set-apache-props" description="Stop apache">
        <apachectl command="stop" />
    </target>

    <target name="apache-stop-lb" depends="set-apache-props-lb" description="Stop apache">
        <apachectl command="stop" />
    </target>

    <target name="tomcat-clean" description="Delete exploded war directory">
        <delete dir="${war.exploded.dir}"/>
        <delete dir="${tomcat.dir}/work" />
    </target>

    <target name="tomcat-start" depends="tomcat-clean" description="Start tomcat">
        <property name="tomcat.coverage.path" location="${coverage.data.file.webapp}" />
        <copy
            file="${coverage.data.file.base}"
            tofile="${tomcat.coverage.path}"
            overwrite="true"
            failonerror="false"
        />
        <exec executable="bash" failonerror="true">
            <arg value="${tomcat.dir}/bin/catalina.sh"/>
            <arg value="start"/>
            <env key="JAVA_OPTS" value="${tomcat.java.opts}"/>
            <env key="CATALINA_OPTS"
                 value="-Dnet.sourceforge.cobertura.datafile=${tomcat.coverage.path}"
            />
        </exec>
        <echo>Waiting for tomcat to start...</echo>
        <parallel threadCount="2" timeout="200000">
            <daemons>
                <exec executable="tail" failonerror="false" timeout="100000">
                    <arg value="-f"/>
                    <arg value="${tomcat.dir}/logs/catalina.out"/>
                </exec>
            </daemons>
            <waitfor maxwait="3" maxwaitunit="minute" checkevery="1" checkeveryunit="second">
                <http url="http://localhost:8080/${servlet.name}/login"/>
            </waitfor>
        </parallel>
        <echo>...done!</echo>
    </target>
    
    <target name="tomcat-stop" description="Stop tomcat">
        <exec executable="bash" failonerror="true">
            <arg value="${tomcat.dir}/bin/catalina.sh"/>
            <arg value="stop"/>
        </exec>
    </target>


</project>
