<?xml version="1.0"?>
<project name="test">
    <property file="${imported.basedir}/default.test.properties" />

    <taskdef classpath="${build.lib.dir}/checkstyle-all-5.1.jar"
             resource="checkstyletask.properties"
    />

    <!-- COBERTURA-RELATED DEFINITIONS -->
    <if>
        <!-- if the coverage lib dir is defined, we assume it has something in it-->
        <available file="${coverage.lib.dir}" type="dir" />
        <!-- so go ahead and attempt cobertura task definitions -->
        <then>
            <path id="cobertura.classpath">
                <fileset dir="${coverage.lib.dir}" />
                <fileset dir="${test.lib.dir}" includes="*.jar" />
            </path>
            <taskdef classpathref="cobertura.classpath" resource="tasks.properties" />
        </then>
        <!-- otherwise, warn that it isn't there, and fail if coverage reports were requested -->
        <else>
            <echo>WARNING: no coverage library directory found at '${coverage.lib.dir}'</echo>
            <fail if="build.cobertura">FATAL: test coverage requested but not possible</fail>
            <!-- if we didn't abort, define an empty path with the same ID for test.classpath.* -->
            <path id="cobertura.classpath" />
        </else>
    </if>


    <!-- these imports aren't necessary but eclipse displays errors if they're not here-->
    <import file="deployTargets.xml"/>
    <import file="dbTargets.xml"/>
    <import file="serverTargets.xml"/>
    <import file="ivyTargets.xml"/>

    <path id="test.classpath.base">
        <path refid="cobertura.classpath" />
        <fileset dir="${test.lib.dir}" includes="*.jar" />
        <fileset dir="${tested.classes.dir}" includes="**/*.jar" />
        <pathelement location="${unit.test.classes.dir}" />
    </path>
    <path id="test.classpath.run-base">
        <path refid="test.classpath.base" />
        <pathelement location="${app.resources.dir}" />
        <pathelement location="${common.resources.dir}" />
        <pathelement location="${common.test.resources.dir}" />
    </path>
    <path id="test.classpath.run-integration">
        <path refid="test.classpath.run-base" />
        <pathelement location="${test.src.dir}" />
        <pathelement location="${webdriver.test.classes.dir}" />
        <pathelement location="${integration.test.classes.dir}" />
    	<pathelement location="${webservice.test.classes.dir}" />
    </path>

    <target name="test-quick" description="Run embarassing-to-fail tests" depends="quicktests"/>
    
    <target
        name="quicktests"
        depends="test-compile,jslint,template-lint,checkstyle,test-unit"
    />

    <target name="alltests">
        <trycatch>
            <try>
                <antcall target="alltests-run"/>
            </try>
            <finally>
                <antcall target="tomcat-stop"/>
                <antcall target="apache-stop"/>
                <antcall target="apache-start"/>
            </finally>
        </trycatch>
    </target>

    <target name="test-all" description="all tests" depends="alltests"/>
        
    <target name="alltests-run" 
        depends="ivy-clean-deploy-steps,
        checkstyle, template-lint,
        test-unit,
        clear-schema, load-baseline-database, migrate-schema,
        test-integration, test-webservice,
        rollback-schema,
        load-fixtures-snapshot,
        apache-stop, tomcat-start, apache-start, 
        test-webdriver"/>

    <target name="test-clean">
        <delete dir="${test.classes.dir}" />
        <delete dir="${webdriver.test.classes.dir}" />
        <delete dir="${unit.test.classes.dir}" />
        <delete dir="${integration.test.classes.dir}" />
        <delete dir="${webservice.test.classes.dir}"/>
        <delete dir="${results.dir}" />
        <delete dir="${reports.dir}" />
    </target>

    <!-- Compile junit test classes -->
    <target name="test-compile" depends="test-clean, build-app-jars, unzip-web-assets, cobertura-instrument-jars"
        description="Compile the tests">

        <mkdir dir="${test.classes.dir}" />
        <mkdir dir="${unit.test.classes.dir}" />
        <mkdir dir="${integration.test.classes.dir}" />
        <mkdir dir="${webservice.test.classes.dir}"/>
        <mkdir dir="${webdriver.test.classes.dir}" />
        <mkdir dir="${results.dir}" />

        <path id="test.classpath.compile">
            <path refid="test.classpath.base" />
            <pathelement location="${integration.test.classes.dir}" />
            <pathelement location="${webservice.test.classes.dir}"/>
            <pathelement location="${webdriver.test.classes.dir}" />
<!-- TODO put libs in ivy and reference from ivy_lib... get rid of below -->
            <fileset dir="${test.lib.dir}" includes="**/*.jar"/>
            <fileset dir="${jar.outdir}">
                <include name="${jar.common.app.name}-${rpm.version}.jar"/>
                <include name="${jar.common.web.name}-${rpm.version}.jar"/>
            </fileset>
        </path>

        <macrodef name="javac-test">
            <attribute name="srcdir" />
            <attribute name="destdir" />
            <element name="javac-nested" implicit="true" optional="true"/>
            <sequential>
                <javac 
                    srcdir="@{srcdir}"
                    destdir="@{destdir}"
                    excludes="${test.src.exclude}"
                    classpathref="test.classpath.compile"
                    deprecation="${build.deprecation}"
                    debug="on"
                    optimize="${build.optimization}"
                    compiler="${build.compiler}"
                    source="${build.source}"
                    target="${build.target}"
                    encoding="UTF-8"
                    includeantruntime="no"
                >
                    <javac-nested />
                </javac>
            </sequential>
        </macrodef>

        <!-- Compile the app unit tests -->
        <javac-test srcdir="${app.unit.src.dir}" destdir="${unit.test.classes.dir}" />

        <!-- Compile the app integration tests -->
        <javac-test  srcdir="${app.integration.src.dir}" destdir="${integration.test.classes.dir}" />

        <!-- Compile the app webservice tests -->
        <javac-test srcdir="${app.webservice.src.dir}" destdir="${webservice.test.classes.dir}"  />

        <!-- Compile the app webdriver tests -->
        <javac-test  srcdir="${app.webdriver.src.dir}" destdir="${webdriver.test.classes.dir}" />

        <!-- Copy spring context to integration test dir -->
        <copy todir="${integration.test.classes.dir}" encoding="UTF-8">
            <fileset dir="${common.context.src.dir}" includes="*-context.xml"/>
            <fileset dir="${app.context.src.dir}" includes="*-context.xml,*-servlet.xml,spring.xml"/>
            <filterset begintoken="&quot;" endtoken="&quot;">
                <filter token="ui-context.xml" value="&quot;test-ui-context.xml&quot;"/>
            </filterset>
        </copy>
        <!-- copy test-specific spring context (no filtering games need be played) -->
        <copy todir="${integration.test.classes.dir}" encoding="UTF-8">
            <fileset dir="${context.integration.dir}" includes="*-context.xml"/>
            <fileset dir="${context.common.integration.dir}" includes="*-context.xml"/>
            <fileset dir="${context.webdriver.dir}" includes="*-context.xml"/>
        </copy>
        <!-- Copy freemarker templates to integration test dir, for tests that use FreeMarkerMerger -->
        <copy todir="${integration.test.classes.dir}/freemarker" encoding="UTF-8">
            <fileset dir="${app.freemarker.dir}" includes="**/*.ftl"/>
        </copy>
        <copy todir="${integration.test.classes.dir}/freemarker/common" encoding="UTF-8">
            <fileset dir="${common.freemarker.dir}" includes="**/*.ftl"/>
        </copy>
    	
    </target>
	
    <target name="zip-test-bundle" depends="test-compile"
            description="Zips up all the resources you need to run this project's tests remotely (with the test-one-precompiled or test-webdriver-precompiled target)">
        <zip destfile="${output.dir}/testbundle.zip">
            <zipfileset dir="${test.classes.dir}" prefix="${test.classes.dir}" /> <!-- compiled tests -->
            <zipfileset dir="${test.lib.dir}" prefix="${test.lib.dir}" /> <!-- ivy_lib/test -->
            <zipfileset dir="${jar.outdir}" prefix="${jar.outdir}" /> <!-- webapp jars -->
            <zipfileset dir="${build.web.assets.dir}" prefix="${build.web.assets.dir}" /> <!-- static files and Spring configs -->
            <zipfileset dir="${results.dir}" excludes="**/*" prefix="${results.dir}" /> <!-- junit needs an empty target/results dir -->
            <zipfileset dir="${app.dir}" includes="*.xml" /> <!-- build.xml and others -->
            <zipfileset dir="${app.config.dir}" includes="**/*.xml" prefix="${app.config.dir}" /> <!-- conf and conf/base -->
            <zipfileset dir="${app.config.dir}" includes="**/*.properties" prefix="${app.config.dir}" />
            <zipfileset dir="${app.config.dir}" includes="**/*.pgpass" prefix="${app.config.dir}" />
            <zipfileset dir="${app.config.dir}" includes="**/*.sh" prefix="${app.config.dir}" />
            <zipfileset dir="${app.config.dir}" includes="**/*.template" prefix="${app.config.dir}" />
            <zipfileset dir="${app.resources.dir}" prefix="src/main/resources" />
            <zipfileset dir="${test.resources.dir}" prefix="src/test/resources" />
            <zipfileset dir="sql_snaps" prefix="sql_snaps" />
        </zip>		
    </target>

    <macrodef name="junit-explicit">
        <attribute name="label" />
        <attribute name="classpathref" />
        <attribute name="coverage-file" default="${coverage.data.file.ignored}" />
        <element name="junit-filesets" implicit="true" optional="false" />
        <sequential>
            <if>
                <available file="${coverage.data.file.base}" />
                <!-- copy base coverage file, overwriting previous version for this test -->
                <!-- but don't make a fuss if it's not there to copy -->
                <then>
                    <copy
                        file="${coverage.data.file.base}"
                        tofile="@{coverage-file}"
                        overwrite="true"
                    />
                </then>
            </if>
            <junit
                fork="yes"
                forkmode="perBatch"
                haltonfailure="false"
                haltonerror="false"
                printsummary="yes"
                showoutput="yes"
                failureproperty="junit.failed"
                maxmemory="512m"
                >
                <sysproperty key="${common.config.dir.property}" value="${common.config.dir}" />
                <sysproperty key="${app.config.dir.property}" value="${app.config.dir}"/>
                <sysproperty key="app.freemarker.source.dir" file="${app.dir}/src/main/webapp/WEB-INF/freemarker" />
                <sysproperty key="common.freemarker.source.dir" file="${common.web.dir}/WEB-INF/freemarker" />
                <formatter type="brief" />
                <formatter type="xml" />

                <classpath refid="@{classpathref}" />
                <sysproperty key="net.sourceforge.cobertura.datafile" file="@{coverage-file}" />

                <jvmarg value="-Xmx256m" />
            	<!--<jvmarg value="${test.vm.args}" />-->
                <batchtest todir="${results.dir}">
                    <junit-filesets />
                </batchtest>

            </junit>
            <if>
                <istrue value="${junit.failed}" />
                <then>
                    <concat>
                        <header filtering="no" trimleading="yes">
                              TEST FAILURES
                              =============
                        </header>
                        <fileset dir="${results.dir}" includes="TEST-*.txt" />
                        <filterchain>
                            <linecontainsregexp>
                                <regexp pattern="Testcase.*(ERROR|FAILED)" />
                            </linecontainsregexp>
                        </filterchain>
                    </concat>
                   <fail message="@{label} failed" />
               </then>
            </if>
        </sequential>
    </macrodef>

    <macrodef name="junit-standard">
        <attribute name="label" />
        <attribute name="classpathref" />
        <attribute name="testdir" />
        <attribute name="coverage-file" />
        <sequential>
            <junit-explicit 
                label="@{label}" classpathref="@{classpathref}" coverage-file="@{coverage-file}" >
                <fileset
                        dir="@{testdir}"
                        includes="${tests.include}"
                        excludes="${tests.exclude}"
                />
            </junit-explicit>
        </sequential>
    </macrodef>

    <target name="test-one" depends="one" description="run one test (see target 'one')"/>

    <target name="one" depends="test-clean, test-compile" 
        description="Run a single test: use with -Dtest=NameOfTest">
        <junit-explicit label="Cherry-picked tests" classpathref="test.classpath.run-integration">
            <fileset dir="${unit.test.classes.dir}" includes="**/${test}.class" />
            <fileset dir="${integration.test.classes.dir}" includes="**/${test}.class" />
            <fileset dir="${webservice.test.classes.dir}" includes="**/${test}.class" />
            <fileset dir="${webdriver.test.classes.dir}" includes="**/${test}.class" />
        </junit-explicit>
    </target>

    <target name="test-one-precompiled"
        description="Run a single test that's already compiled: use with -Dtest=NameOfTest">
        <junit-explicit label="Cherry-picked tests" classpathref="test.classpath.run-integration">
            <fileset dir="${unit.test.classes.dir}" includes="**/${test}.class" />
            <fileset dir="${integration.test.classes.dir}" includes="**/${test}.class" />
            <fileset dir="${webservice.test.classes.dir}" includes="**/${test}.class" />
            <fileset dir="${webdriver.test.classes.dir}" includes="**/${test}.class" />
        </junit-explicit>
    </target>

    <target name="test-parallel"
            depends="zip-test-bundle"
            description="Run all integration and webservice tests (webdriver coming soon) in parallel using runParallelTests.py">
        <exec executable="bash" failonerror="true">
            <arg value="-c" />
            <!-- All but one of these values come from conf/default.test.properties.  build.name gets written to conf/build.properties by hudson. -->
            <arg value="time find target/test/integration target/test/webservice | grep Test.class | xargs -i basename {} .class | python ${imported.basedir}/scripts/build/runParallelTests.py -s ${parallel.test.hosts} -u ${parallel.test.ssh.user} -i ${parallel.test.ssh.identity.file} -w ${build.name} -v ${parallel.test.app.home.env.var}" />
        </exec>
    </target>

    <target name="test-webdriver" depends="test-clean, clean, test-compile"
        description="Run all webdriver tests">
        <!-- PLEASE NOTE THIS COVERAGE FILE DOES NOT FOLLOW THE PATTERN -->
        <junit-standard
            label="Webdriver tests"
            classpathref="test.classpath.run-integration"
            testdir="${webdriver.test.classes.dir}"
            coverage-file="${coverage.data.file.ignored}"
        />
    </target>
	
    <target name="test-webdriver-precompiled" description="Run all webdriver tests without compiling them; meant for running the tests on a remote host">
        <!-- PLEASE NOTE THIS COVERAGE FILE DOES NOT FOLLOW THE PATTERN -->
        <junit-standard
            label="Webdriver tests"
            classpathref="test.classpath.run-integration"
            testdir="${webdriver.test.classes.dir}"
            coverage-file="${coverage.data.file.ignored}"
        />
    </target>

    <target name="test-slow" depends="test-clean, test-compile" 
        description="Run all tests with the @Slow annotation">

		<!--set slow tests to run in the properties file-->
		<property name="run.slow.smoke.tests" value="true" file="${app.config.dir}/${servlet.name}.properties" />

        <antcall target="test-webdriver" />
		
        <!--unset slow tests to run in the properties file-->
        <property name="run.slow.smoke.tests" value="false" file="${app.config.dir}/${servlet.name}.properties" />

     </target>
    
    <target name="test-webservice" depends="test-clean, test-compile" 
            description="Run all webservice tests">
        <junit-standard
            label="Webservice tests"
            testdir="${webservice.test.classes.dir}"
            classpathref="test.classpath.run-integration"
            coverage-file="${coverage.data.file.test-webservice}"
        />
    </target>

    <target name="test-integration" depends="test-clean, test-compile, test-integration-wgspringcore" 
        description="Run all integration tests">
        <junit-standard
            label="Integration tests"
            testdir="${integration.test.classes.dir}"
            classpathref="test.classpath.run-integration"
            coverage-file="${coverage.data.file.test-integration}"
        />
    </target>
    
    <target name="test-integration-wgspringcore" description="Run tests found in wgspringcore-integration-test-*.jar"
        depends="test-clean, test-compile" >
        <!-- find the latest version of the wgspringcore-integration-test jar -->
        <pathconvert property="jar-containing-tests" targetos="unix" pathsep="">
            <fileset dir="${ivy.lib.dir}/test"
                includes="wgspringcore-integration-test-*.jar"
                excludes="wgspringcore-integration-test-src-*.jar"/>
        </pathconvert>
        <echo>running tests in ${jar-containing-tests}</echo>
        <sequential>
            <junit-explicit
                label="wgspringcore integration tests"
                classpathref="test.classpath.run-integration"
                coverage-file="${coverage.data.file.test-integration}" >
                <zipfileset src="${jar-containing-tests}"
                            includes="${tests.include}"
                            excludes="${tests.exclude}" />
            </junit-explicit>
        </sequential>
    </target>
	
    <target name="test-unit" depends="test-clean, test-compile" 
        description="Run all unit tests">
        <junit-standard
            label="Unit tests"
            classpathref="test.classpath.run-base"
            testdir="${unit.test.classes.dir}"
            coverage-file="${coverage.data.file.test-unit}"
        />
    </target>

    <target name="-cobertura-setup" if="build.cobertura">
        <mkdir dir="${coverage.data.dir}" />
    </target>

    <target name="cobertura-instrument-jars" if="build.cobertura" depends="-cobertura-setup">
        <if>
            <not>
                <uptodate targetfile="${coverage.data.file.base}">
                    <srcfiles dir="${jar.outdir}" includes="*.jar" />
                </uptodate>
            </not>
            <then>
                <cobertura-instrument datafile="${coverage.data.file.base}">
                    <includeClasses regex=".*" />
                    <excludeClasses regex=".*\bURL(Prefix|Param)" />
                    <excludeClasses regex=".*\bModel(Keys|Attr)" />
                    <excludeClasses regex=".*\bJSONKey(s?)" />
                    <excludeClasses regex=".*\bTemplates" />
                    <instrumentationClasspath>
                        <fileset dir="${jar.outdir}" includes="*.jar" />
                    </instrumentationClasspath>
                </cobertura-instrument>
            </then>
        </if>
    </target>

    <target name="-cobertura-merge">
        <!-- we could try to get fancy and use a "depend" filter on the fileset below -->
        <!-- or we could just re-do the merge every time.  Seems simpler this way -->
        <delete file="${coverage.data.file.combined}" />
        <cobertura-merge datafile="${coverage.data.file.combined}">
            <fileset dir="${coverage.data.dir}">
                <include name="*.ser" />
                <exclude name="${coverage.data.file.ignored}" />
            </fileset>
        </cobertura-merge>
    </target>

    <!-- turn a supplied cobertura data file into a human-readable report -->
    <macrodef name="cobertura-html-report">
        <attribute name="datafile" />
        <attribute name="report-subdir" />
        <sequential>
            <mkdir dir="${coverage.reports.dir}/@{report-subdir}" />
            <cobertura-report
                format="html"
                datafile="@{datafile}"
                destdir="${coverage.reports.dir}/@{report-subdir}"
            >
                <fileset dir="${app.src.dir}" />
            </cobertura-report>
        </sequential>
    </macrodef>

    <!-- shortcut to generate an HTML report for a specific test suite -->
    <macrodef name="cobertura-test-suite-report">
        <attribute name="subreport-tag" />
        <sequential>
            <cobertura-html-report
                datafile="${coverage.data.file.test-@{subreport-tag}}"
                report-subdir="@{subreport-tag}"
            />
        </sequential>
    </macrodef>

    <target name="cobertura-report-unit"
             description="Human-readable coverate report for unit tests">
        <cobertura-test-suite-report subreport-tag="unit" />
    </target>

    <target name="cobertura-report-integration"
             description="Human-readable coverate report for integration tests">
        <cobertura-test-suite-report subreport-tag="integration" />
    </target>

    <target name="cobertura-report-webservice"
             description="Human-readable coverate report for webservice tests">
            <cobertura-test-suite-report subreport-tag="webservice" />
    </target>

    <target name="cobertura-report-all"
        depends="cobertura-report,
             cobertura-report-unit,cobertura-report-integration,cobertura-report-webservice"
        description="Create reports for each sub-category of tests."
    />

    <target name="cobertura-report" depends="-cobertura-merge"
        description="Create a human-readable test coverage report combining all test suites"
        >
        <cobertura-html-report datafile="${coverage.data.file.combined}" report-subdir="" />
    </target>

    <target name="cobertura-report-xml" depends="-cobertura-merge"
        description="Create a machine-readable test coverage report"
        >
        <mkdir dir="${coverage.reports.dir}" />
        <cobertura-report
            format="xml"
            datafile="${coverage.data.file.combined}"
            destdir="${coverage.reports.dir}"
            >
            <fileset dir="${app.src.dir}" />
        </cobertura-report>
    </target>

    <target name="cobertura-dump-webapp">
        <fail message="dump request failed">
            <condition>
                <not>
                    <http
                     url="http://localhost:8080/${servlet.name}/liveops/webservices/cobertura/dump"
                     />
                </not>
            </condition>
        </fail>
    </target>

    <target name="checkstyle" description="Run checkstyle">
        <mkdir dir="${results.dir}"/>

        <checkstyle config="${imported.basedir}/checkstyle.xml" failonviolation="true">
            <fileset dir="${app.src.dir}" includes="**/*.java" />
            <fileset dir="${app.unit.src.dir}" includes="**/*.java" />
            <fileset dir="${app.integration.src.dir}" includes="**/*.java" />
            <fileset dir="${app.webservice.src.dir}" includes="**/*.java" />
            <fileset dir="${app.webdriver.src.dir}" includes="**/*.java" />  
            <formatter type="xml" toFile="${results.dir}/checkstyle-errors.xml" />
            <formatter type="plain" usefile="false" />
        </checkstyle>
        <fail if="checkstyle.failed" message="Checkstyle failed" />
    </target>

    <target name="checkstyleWithLayeringViolations"
        description="Run checkstyle with layering violations">
        <mkdir dir="${results.dir}"/>

        <checkstyle config="${imported.basedir}/checkstyleWithLayeringViolations.xml" failonviolation="true" >
            <fileset dir="${common.src.dir}" includes="**/*.java" />
            <formatter type="xml" toFile="${results.dir}/checkstyle-errors.xml" />
            <formatter type="plain" usefile="false" />
        </checkstyle>
        
        <checkstyle config="${app.dir}/checkstyleWithLayeringViolations.xml" failonviolation="true" classpathref="checkstyle.classpath">
            <fileset dir="${app.src.dir}" includes="**/*.java" />
            <formatter type="xml" toFile="${results.dir}/checkstyle-errors.xml" />
            <formatter type="plain" usefile="false" />
        </checkstyle>
        <fail if="checkstyle.failed" message="Checkstyle failed" />
    </target>

<!-- TODO figure out a way to not be dependent on a version -->

    <target name="jslint">
        <taskdef name="jslint" classname="com.googlecode.jslint4java.ant.JSLintTask" classpath="${build.lib.dir}/jslint4java-1.3.3.jar" />
        <jslint haltOnFailure="${jslint.fatal}" options="browser, sub, forin">
            <predef>$$j,Class</predef>
            <formatter type="xml" destFile="${results.dir}/jslint-errors.xml" />
            <formatter type="plain"/>
            <fileset dir="${app.static.dir}" excludes="**/3p/**/*.js" includes="**/*.js" />
        </jslint>
        <exec executable="grep"
              outputproperty="build.js.grep.output"
              resultproperty="build.js.grep.return"
              failonerror="false">
           <arg value="-r" />
           <arg value="${app.web.dir}/WEB-INF/freemarker" />
           <arg value="${app.web.dir}/static/js" />
           <arg value="-F" />
           <arg value="-e" />
           <arg value="$j.get" />
           <arg value="-e" />
           <arg value="$j.post" />
           <arg value="-e" />
           <arg value="$j.ajax" />
           <arg value="--exclude" />
           <arg value="global_ready.js" />
        </exec>
        <condition property="build.js.errors">
            <and>
                <equals arg1="0" arg2="${build.js.grep.return}" />
                <istrue value="${jslint.fatal}" />
            </and>
        </condition>
        <fail if="build.js.errors" >
            ${build.js.grep.output}
        </fail>
    </target>
    
    <target name="jslint-common">
        <taskdef name="jslint" classname="com.googlecode.jslint4java.ant.JSLintTask" classpath="${build.lib.dir}/jslint4java-1.3.3.jar" />
        <jslint options="browser, devel">
            <predef>$$j,Class</predef>
            <formatter type="xml" destFile="${results.dir}/jslint-errors.xml" />
            <formatter type="plain"/>
            <fileset dir="${common.static.dir}" excludes="**/3p/**/*.js" includes="**/*.js" />
        </jslint>
    </target>

    <!-- Don't use this for now... -->
    <target name="jslint-css">
        <taskdef name="jslint" classname="com.googlecode.jslint4java.ant.JSLintTask" classpath="${build.lib.dir}/jslint4java-1.3.3.jar" />
        <jslint options="css">
            <formatter type="plain" destfile="${results.dir}/jslint_css.out" />
            <fileset dir="${app.static.dir}" includes="**/*.css" />
            <fileset dir="${common.static.dir}" includes="**/*.css" />
        </jslint>
    </target>

    <target name="template-lint"
        description="Check templates for static URLS and any other bad behaviors" >
        <exec executable="grep"
              outputproperty="build.template.grep.output"
              resultproperty="build.template.grep.return"
              failonerror="false">
           <arg value="-r" />
           <arg value="${app.web.dir}/WEB-INF/freemarker" />
           <!-- check for hard-coding of the context name -->
           <arg value="-e" />
           <arg value="/${servlet.name}" />
           <!-- check for manual imports of auto-imported utility macros -->
           <arg value="-e" />
           <arg value="util.ftl" />
           <!-- customization file is the only place those strings are allowed to appear -->
           <arg value="--exclude" />
           <arg value="util_constants.ftl" />
        </exec>
        <condition property="build.template.errors">
            <equals arg1="0" arg2="${build.template.grep.return}" />
        </condition>
        <fail if="build.template.errors" >
            ${build.template.grep.output}
        </fail>
    </target>
    <target name="this-too-shall-pass">
        <echo>
    LUCY:             For now we're healthy.
    BRIAN:            For now we're employed.
    BAD IDEA BEARS:   For now we're happy...
    KATE MONSTER:     If not overjoyed.
    PRINCETON:        And we'll accept the things we cannot avoid,
                      For now...
    GARY COLEMAN:     For now...
    TREKKIE MONSTER:  For now...
    KATE MONSTER:     For now...
    ALL:              But only for now!
        </echo>
    </target>
</project>
