#!/usr/bin/python
from __future__ import print_function
import os, sys
import re

# counts the number of css selectors in css files. Does not handle sass files.
# selects a media query: (?:\s*@media\s*[^\{]*(\{))
# selects anything followed by a , or { excluding comments:  (?:\s*(?:[^,\{]*(?:(,)|(\{)(?:[^\}]*\}))))
# ( ?:\s*@media\s*[^\{]*  (\{) ) ? ( ?:\s*  (?:[^,\{]* (?: (,)|  (\{)  (?:[^\}]*\}) )) )
def count_css_selectors(fileName):
    count = 0;
    patternRules = '([^\{]+\{(?:[^\{\}]|\{[^\{\}]*\})*\})'
    patternSelectors = '(?:\s*@media\s*[^\{]*(\{))?(?:\s*(?:[^,\{]*(?:(,)|(\{)(?:[^\}]*\}))))' #also looks inside media queries
    commentsPattern = '(\/\*[^*]*\*+([^/*][^*]*\*+)*\/)'
    with open (fileName, "r") as cssFile:
        data = cssFile.read()
        rules = re.findall(patternRules, data)
        for rule in rules:
            # remove comments
            rule = re.sub(commentsPattern, '', rule)
            selectorMatches = re.findall(patternSelectors, rule)
            for selectorMatch in selectorMatches:
            count = count + len(selectorMatches)
    return count;

# renames css files to scss
def rename_css_to_scss(stylesFileName):
    if '.css' in stylesFileName:
        sassName = stylesFileName.replace('.css', '.scss')
        print("Changing extension of " + stylesFileName + " to scss.")
        os.rename(stylesFileName, sassName)
        return sassName
    else:
        return stylesFileName

# for all the css files in stylesFileList, changes the extension to scss and imports all in a new scss file
def create_combined_sass_file(stylesFileList, outputFilePath):
    totalSelectorsCount = 0;
    outputFile = open(outputFilePath, 'w+')
    print("creating combined scss file at " + outputFilePath)
    for stylesFileName in stylesFileList:
        totalSelectorsCount += count_css_selectors(stylesFileName)
        if (totalSelectorsCount > 4095):
            print("whoa, selectors count is over 4095 limit for IE, you need to use another manifest file to include the extra styles")
            return 1;
        fileToImport = rename_css_to_scss(stylesFileName)
        print('@import "' + fileToImport + '";', file=outputFile)
    return 0;

# test REMOVE!!!!!!!!
create_combined_sass_file(["a.scss", "b.scss"], "hohoho.scss")

